- [TCP/IP](#tcpip)
  - [TCP/IP协议4层模型](#tcpip协议4层模型)
  - [可靠传输](#可靠传输)
    - [校验和](#校验和)
    - [序列号、确认应答号](#序列号确认应答号)
      - [序列号](#序列号)
      - [确认应答号](#确认应答号)
    - [重传机制](#重传机制)
      - [超时重传管理](#超时重传管理)
      - [高速重发控制](#高速重发控制)
    - [滑动窗口](#滑动窗口)
    - [流量控制](#流量控制)
    - [拥塞控制](#拥塞控制)

## TCP/IP

### TCP/IP协议4层模型

+ 应用层

+ 传输层

+ 网络层（网际层）

+ 网络接口层

<img title="" src="file:///Users/sgy/Desktop/note/just-code/bagu/img/tcpip4.png" alt="">

我们平时学习研究一般用的是五层模型：

<img title="" src="file:///Users/sgy/Desktop/note/just-code/bagu/img/study.png" alt="">

每一层对应的协议

<img title="" src="file:///Users/sgy/Desktop/note/just-code/bagu/img/schema.png" alt="">

### 可靠传输

TCP通过校验和、序列号、确认应答、重发控制、连接管理、窗口控制等实现可靠传输。

#### 校验和

检验和（checksum）是TCP首部的一个字段，是由发送方根据伪首部+数据信息计算得到，由接收端验证。目的是为了发现TCP首部和数据在发送端到接收端之间是否有改动。如果接收方检测到校验和有差错，则TCP段会被直接丢弃。

**通过校验和，TCP 能够识别内是否有改变，从而保证可靠性**

> 伪首部：包括源IP地址、目标IP地址、协议号、TCP包长度；占12字节，**仅在计算校验和时起作用，不会传给网络层**。

#### 序列号、确认应答号

##### 序列号

序列号字段占4个字节，实际上在传输数据中的每一个字节都会有一个编号，这里说的序列号是指这一次传给对方的**TCP数据部分的第一个字节的编号**；

##### 确认应答号

确认应答字段也占4个字节，这里指期望对方**下一次传过来的TCP数据部分的第一个字节的编号**。

这样通过序列号和确认应答号这个机制，我们就可以知道是否已经接收数据以及是否需要接收数据，TCP以此实现可靠传输。

#### 重传机制

##### 超时重传管理

重发超时时间指的是往返时间+偏差。

**如果发送端在在超过了这个时间仍未收到来自接收方的确认报文，可能为报文段丢失或 ACK 确认报文丢失，发送端就会进行数据重发。**

如果数据重发后依然收不到确认应答，则再次发送，同时重传超时时间加倍。

达到一定重发次数之后，如果仍没有任何确认应答返回，就会判断为网络或对端主机发生了异常，强制关闭连接，并且通知应用通信异常强行终止。

##### 高速重发控制

接收主机如果收到一个自己应该接收的序列号以外的数据时，会针对当前为止收到的数据返回确认应答号，指明下一个期待字节的序号，发送确认应答号。

在窗口比较大时，又出现报文段丢失的情况，同一序号的确认应答会被重复不断的返回。**当发送端主机连续3次收到同一个确认应答时，即会认为该序号的报文段丢失，就会将其所对应的数据重发**。

#### 滑动窗口

如果TCP以1个段为单位，每发一个段进行一次确认应答的处理，那么包的往返时间越长通信性能越低。引入窗口概念，控制网络性能的下降。

> 窗口大小由接收端主机决定，接收端主机会通知发送端自己可以接收数据的大小，发送端就会按着该限度发送数据。该大小限度就是窗口大小。

确认应答以窗口为单位进行确认，替代原有的以分段为单位进行确认。

发送端主机，在发送了一个段以后不必要一直等待确认应答，而是继续发送。

- 发送端主机在收到确认应答前，需要设置缓存保留这些可能被重传的数据，直到收到他们的确认应答
- 当收到确认应答，不需要重传时，数据可从缓冲区清除
- 收到确认应答的情况下，将窗口滑动到确认应答中的序列号的位置

#### 流量控制

对发送端发送数据量的控制就是流量控制。

之前提到，**接收端主机会通知发送端自己可以接收数据的大小**，这个大小是可变的，取决于接收端剩余缓冲区大小；所以**发送端主机会根据接收端主机的提示，对发送数据的量进行控制——流量控制**。

- 接收端主机根据自己可缓冲区可接受的大小，将其作为窗口大小，存入 TCP 首部，向发送端主机通知自己可以接受的数据大小
- 发送端发送不超过该限度（即窗口大小）的数据
- 如果接收到窗口大小的值为 0，那么发送方将停止发送数据。

> 接收端在收到接收端窗口更新通知后通信会继续进行；
> 
> 接收端为防止窗口更新通知在传送途中丢失，也会定期向接收端发送窗口探测数据段（一个字节），提醒接收端把窗口大小告诉发送端

<img title="" src="file:///Users/sgy/Desktop/note/just-code/bagu/img/netcontrol.png" alt="">

#### 拥塞控制

避免在通信刚开始发送大量数据。慢开始->拥塞避免->超时重传/快速重传

+ 慢开始：在通信开始，接收端设置拥塞窗口为1个数据段发送数据，每接收到1个确认应答ACK，拥塞窗口变为 $2^{n+1}$ 个数据段（指数上升）

+ 拥塞避免：当拥塞窗口值达到设置的慢开始阈值时，每接收到1个确认应答ACK，拥塞窗口增加1个数据段（线性上升）

+ 当触发**超时重传时**，**慢开始阈值会调整为当前拥塞窗口值的一半，拥塞窗口值恢复到初始值 1**，同时执行慢开始，指数增大。

<img title="" src="file:///Users/sgy/Desktop/note/just-code/bagu/img/slowstart.png" alt="">

- 当触发**快速重传**时，进入快恢复，把阈值调整为拥塞窗口值的一半，**并作为新的拥塞窗口值**。执行拥塞避免，加法增大。

<img title="" src="file:///Users/sgy/Desktop/note/just-code/bagu/img/tcpreno.png" alt="">
